<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TODO List</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: url('background.png') no-repeat center center fixed;
      background-size: cover;
      color: #1a1a2e;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 40px 16px;
    }

    .container {
      width: 100%;
      max-width: 520px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 32px 24px;
    }

    .auth-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 8px 12px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #6b7280;
      gap: 8px;
    }

    .auth-bar .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .auth-bar .user-info img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }

    .auth-bar .user-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .auth-bar button {
      padding: 5px 12px;
      border: 1.5px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      color: #4f46e5;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .auth-bar button:hover {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }

    .sync-status {
      font-size: 0.7rem;
      color: #22c55e;
      white-space: nowrap;
    }

    .data-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      justify-content: flex-end;
    }

    .data-bar button {
      padding: 4px 10px;
      border: 1.5px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.2s;
    }

    .data-bar button:hover {
      border-color: #4f46e5;
      color: #4f46e5;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .title-row img {
      height: 42px;
      width: auto;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .input-row input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .date-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .date-wrapper label {
      position: absolute;
      left: 12px;
      font-size: 0.8rem;
      color: #9ca3af;
      pointer-events: none;
    }

    .date-wrapper.has-value label {
      display: none;
    }

    .input-row input[type="date"] {
      padding: 12px 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.875rem;
      outline: none;
      transition: border-color 0.2s;
      color: #6b7280;
    }

    .input-row select {
      padding: 12px 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.875rem;
      outline: none;
      transition: border-color 0.2s;
      color: #6b7280;
      background: #fff;
      cursor: pointer;
    }

    .input-row select:focus {
      border-color: #4f46e5;
    }

    .input-row textarea {
      width: 100%;
      padding: 8px 16px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.875rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
      resize: vertical;
      min-height: 38px;
      color: #6b7280;
    }

    .input-row input:focus,
    .input-row textarea:focus {
      border-color: #4f46e5;
    }

    .input-row button {
      padding: 12px 20px;
      background: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .input-row button:hover {
      background: #4338ca;
    }

    .filters {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: #e5e7eb;
      border-radius: 8px;
      padding: 4px;
    }

    .filters button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.2s;
    }

    .filters button.active {
      background: #fff;
      color: #1a1a2e;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .sort-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    .sort-bar span {
      font-weight: 500;
      margin-right: 2px;
    }

    .sort-bar button {
      padding: 5px 10px;
      border: 1.5px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      font-size: 0.8rem;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.2s;
    }

    .sort-bar button:hover {
      border-color: #4f46e5;
      color: #4f46e5;
    }

    .sort-bar button.active {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }

    .todo-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .todo-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      transition: opacity 0.2s;
      border-left: 4px solid transparent;
    }

    .todo-item.priority-high {
      border-left-color: #ef4444;
    }

    .todo-item.priority-medium {
      border-left-color: #f59e0b;
    }

    .todo-item.priority-low {
      border-left-color: #22c55e;
    }

    .todo-item.completed {
      opacity: 0.6;
    }

    .todo-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #4f46e5;
      cursor: pointer;
      flex-shrink: 0;
    }

    .todo-item .todo-content {
      flex: 1;
      min-width: 0;
    }

    .todo-item .text {
      font-size: 1rem;
      word-break: break-word;
    }

    .todo-item.completed .text {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .todo-item .tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 3px;
    }

    .tag {
      font-size: 0.675rem;
      font-weight: 500;
      padding: 1px 7px;
      border-radius: 10px;
      background: #e0e7ff;
      color: #3730a3;
    }

    .todo-item .description {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 2px;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .todo-item .meta {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 3px;
      flex-wrap: wrap;
    }

    .todo-item .due-date {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .todo-item .due-date.overdue {
      color: #ef4444;
      font-weight: 600;
    }

    .todo-item .priority-badge {
      font-size: 0.675rem;
      font-weight: 600;
      padding: 1px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .priority-badge.high {
      background: #fef2f2;
      color: #dc2626;
    }

    .priority-badge.medium {
      background: #fffbeb;
      color: #d97706;
    }

    .priority-badge.low {
      background: #f0fdf4;
      color: #16a34a;
    }

    .todo-item .actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .todo-item .edit-btn,
    .todo-item .delete-btn {
      background: none;
      border: none;
      color: #d1d5db;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      border-radius: 4px;
      transition: color 0.2s;
    }

    .todo-item .edit-btn:hover {
      color: #4f46e5;
    }

    .todo-item .delete-btn:hover {
      color: #ef4444;
    }

    .edit-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .edit-form input[type="text"] {
      padding: 8px 10px;
      border: 2px solid #4f46e5;
      border-radius: 6px;
      font-size: 1rem;
      outline: none;
      width: 100%;
    }

    .edit-form textarea {
      padding: 6px 10px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      outline: none;
      width: 100%;
      resize: vertical;
      min-height: 36px;
      color: #6b7280;
    }

    .edit-form textarea:focus {
      border-color: #4f46e5;
    }

    .edit-form .tag-input,
    .input-row .tag-input {
      padding: 8px 10px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.8rem;
      outline: none;
      color: #6b7280;
      flex: 1;
      min-width: 120px;
    }

    .edit-form .tag-input:focus,
    .input-row .tag-input:focus {
      border-color: #4f46e5;
    }

    .edit-form .edit-options {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .edit-form input[type="date"],
    .edit-form select {
      padding: 6px 8px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.8rem;
      outline: none;
      color: #6b7280;
    }

    .edit-form select {
      background: #fff;
      cursor: pointer;
    }

    .edit-form input[type="date"]:focus,
    .edit-form select:focus {
      border-color: #4f46e5;
    }

    .edit-form .edit-actions {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }

    .edit-form .save-btn,
    .edit-form .cancel-btn {
      padding: 5px 12px;
      border: none;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
    }

    .edit-form .save-btn {
      background: #4f46e5;
      color: #fff;
    }

    .edit-form .save-btn:hover {
      background: #4338ca;
    }

    .edit-form .cancel-btn {
      background: #e5e7eb;
      color: #6b7280;
    }

    .edit-form .cancel-btn:hover {
      background: #d1d5db;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding: 0 4px;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .clear-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      font-size: 0.875rem;
      text-decoration: underline;
    }

    .clear-btn:hover {
      color: #ef4444;
    }

    .empty-state {
      text-align: center;
      color: #9ca3af;
      padding: 32px 0;
      font-size: 0.95rem;
    }

    /* Dark mode toggle */
    .dark-toggle {
      background: none;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 4px 10px;
      line-height: 1;
      transition: all 0.2s;
    }

    .dark-toggle:hover {
      border-color: #4f46e5;
    }

    /* Dark mode styles */
    body.dark {
      color: #e5e7eb;
    }

    body.dark .container {
      background: rgba(30, 30, 46, 0.92);
    }

    body.dark h1 {
      color: #e5e7eb;
    }

    body.dark .auth-bar {
      background: #2a2a3e;
      color: #9ca3af;
    }

    body.dark .auth-bar button {
      background: #2a2a3e;
      border-color: #4b5563;
      color: #818cf8;
    }

    body.dark .auth-bar button:hover {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }

    body.dark .data-bar button {
      background: #2a2a3e;
      border-color: #4b5563;
      color: #9ca3af;
    }

    body.dark .data-bar button:hover {
      border-color: #818cf8;
      color: #818cf8;
    }

    body.dark .input-row input[type="text"],
    body.dark .input-row textarea,
    body.dark .input-row input[type="date"],
    body.dark .input-row select,
    body.dark .input-row .tag-input {
      background: #2a2a3e;
      border-color: #4b5563;
      color: #e5e7eb;
    }

    body.dark .input-row input::placeholder,
    body.dark .input-row textarea::placeholder,
    body.dark .input-row .tag-input::placeholder {
      color: #6b7280;
    }

    body.dark .date-wrapper label {
      color: #6b7280;
    }

    body.dark .filters {
      background: #2a2a3e;
    }

    body.dark .filters button {
      color: #9ca3af;
    }

    body.dark .filters button.active {
      background: #3b3b54;
      color: #e5e7eb;
    }

    body.dark .sort-bar button {
      background: #2a2a3e;
      border-color: #4b5563;
      color: #9ca3af;
    }

    body.dark .sort-bar button:hover {
      border-color: #818cf8;
      color: #818cf8;
    }

    body.dark .sort-bar button.active {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }

    body.dark .todo-item {
      background: #2a2a3e;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    body.dark .todo-item .text {
      color: #e5e7eb;
    }

    body.dark .todo-item.completed .text {
      color: #6b7280;
    }

    body.dark .todo-item .description {
      color: #9ca3af;
    }

    body.dark .todo-item .due-date {
      color: #9ca3af;
    }

    body.dark .todo-item .edit-btn,
    body.dark .todo-item .delete-btn {
      color: #4b5563;
    }

    body.dark .todo-item .edit-btn:hover {
      color: #818cf8;
    }

    body.dark .todo-item .delete-btn:hover {
      color: #ef4444;
    }

    body.dark .tag {
      background: #3730a3;
      color: #c7d2fe;
    }

    body.dark .edit-form input[type="text"],
    body.dark .edit-form textarea,
    body.dark .edit-form input[type="date"],
    body.dark .edit-form select,
    body.dark .edit-form .tag-input {
      background: #1e1e2e;
      border-color: #4b5563;
      color: #e5e7eb;
    }

    body.dark .edit-form .cancel-btn {
      background: #3b3b54;
      color: #9ca3af;
    }

    body.dark .status-bar {
      color: #9ca3af;
    }

    body.dark .clear-btn {
      color: #9ca3af;
    }

    body.dark .clear-btn:hover {
      color: #ef4444;
    }

    body.dark .dark-toggle {
      border-color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title-row">
      <img src="logo.png" alt="MarcAI Logo">
      <h1>TODO List</h1>
      <button class="dark-toggle" id="darkToggle" onclick="toggleDarkMode()" title="Toggle dark mode">&#9790;</button>
    </div>

    <div class="auth-bar" id="authBar">
      <div class="user-info">
        <span id="authStatus">Not signed in</span>
      </div>
      <button id="authBtn" onclick="handleAuth()">Sign in with Google</button>
    </div>

    <div class="data-bar">
      <span class="sync-status" id="syncStatus"></span>
      <button onclick="exportTodos()">Export</button>
      <button onclick="document.getElementById('importFile').click()">Import</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importTodos(event)">
    </div>

    <div class="input-row">
      <input type="text" id="todoInput" placeholder="What needs to be done?" autofocus>
      <textarea id="descInput" placeholder="Description (optional)" rows="1"></textarea>
      <div class="date-wrapper" id="dateWrapper">
        <label for="dueDateInput">Due date</label>
        <input type="date" id="dueDateInput" title="Due date (optional)" onchange="updateDateLabel()">
      </div>
      <select id="priorityInput" title="Priority">
        <option value="none">No priority</option>
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
      </select>
      <input type="text" class="tag-input" id="tagInput" placeholder="Tags (comma separated)">
      <button onclick="addTodo()">Add</button>
    </div>

    <div class="filters">
      <button class="active" onclick="setFilter('active', this)">Tasks</button>
      <button onclick="setFilter('completed', this)">Completed</button>
    </div>

    <div class="sort-bar" id="sortBar">
      <span>Sort:</span>
      <button onclick="setSort('name')" id="sortName">Name</button>
      <button onclick="setSort('date')" id="sortDate">Date</button>
      <button onclick="setSort('priority')" id="sortPriority">Priority</button>
    </div>

    <ul class="todo-list" id="todoList"></ul>

    <div class="status-bar" id="statusBar" style="display:none;">
      <span id="itemCount"></span>
      <button class="clear-btn" id="clearCompleted" onclick="clearCompleted()">Clear completed</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase Setup ---
    const firebaseConfig = {
      apiKey: "AIzaSyCcuS6E3lrCyUooGQyTxzepgwUaM0RY2AM",
      authDomain: "todo-list-app-2bcda.firebaseapp.com",
      projectId: "todo-list-app-2bcda",
      storageBucket: "todo-list-app-2bcda.firebasestorage.app",
      messagingSenderId: "74851776009",
      appId: "1:74851776009:web:9521cceec29c10f93caad8",
      measurementId: "G-LBPWJEQZEY"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    // --- App State ---
    let todos = JSON.parse(localStorage.getItem('todos')) || [];
    let currentFilter = 'active';
    let editingId = null;
    let currentSort = null;
    let sortAsc = true;

    // --- DOM Elements ---
    const todoInput = document.getElementById('todoInput');
    const descInput = document.getElementById('descInput');
    const dueDateInput = document.getElementById('dueDateInput');
    const priorityInput = document.getElementById('priorityInput');
    const tagInput = document.getElementById('tagInput');
    const todoList = document.getElementById('todoList');
    const statusBar = document.getElementById('statusBar');
    const itemCount = document.getElementById('itemCount');
    const clearBtn = document.getElementById('clearCompleted');
    const authBtn = document.getElementById('authBtn');
    const authStatus = document.getElementById('authStatus');
    const syncStatus = document.getElementById('syncStatus');

    todoInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addTodo();
    });

    // --- Auth ---
    function handleAuth() {
      if (currentUser) {
        auth.signOut();
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        // Try popup first, fall back to redirect if blocked
        auth.signInWithPopup(provider).catch(err => {
          if (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user') {
            auth.signInWithRedirect(provider);
          } else {
            syncStatus.textContent = err.code;
          }
        });
      }
    }

    // Handle redirect result on page load (fallback from popup)
    auth.getRedirectResult().then(result => {
      if (result && result.user) {
        syncStatus.textContent = 'Signed in!';
      }
    }).catch(err => {
      if (err.code && err.code !== 'auth/no-auth-event') {
        syncStatus.textContent = err.code;
      }
    });

    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        authStatus.innerHTML = `<img src="${user.photoURL || ''}" alt=""> <span class="user-name">${user.displayName || user.email}</span>`;
        authBtn.textContent = 'Sign out';
        loadFromCloud();
      } else {
        authStatus.textContent = 'Not signed in';
        authBtn.textContent = 'Sign in with Google';
        syncStatus.textContent = '';
      }
    });

    // --- Firestore Sync (simple: load on open, save on change) ---
    function getUserDoc() {
      return db.collection('users').doc(currentUser.uid);
    }

    function loadFromCloud() {
      if (!currentUser) return;
      syncStatus.textContent = 'Loading...';
      getUserDoc().get({ source: 'server' }).then(doc => {
        if (doc.exists) {
          todos = doc.data().todos || [];
        } else {
          // First time: push local todos to cloud
          pushToCloud();
        }
        localStorage.setItem('todos', JSON.stringify(todos));
        syncStatus.textContent = 'Synced';
        render();
      }).catch(err => {
        syncStatus.textContent = 'Error: ' + err.code;
      });
    }

    function pushToCloud() {
      if (!currentUser) return;
      syncStatus.textContent = 'Saving...';
      const copy = JSON.parse(JSON.stringify(todos));
      getUserDoc().set({ todos: copy }).then(() => {
        syncStatus.textContent = 'Saved';
      }).catch(err => {
        syncStatus.textContent = 'Save error: ' + err.code;
      });
    }

    // Reload from cloud when page becomes visible (phone wakes up, tab refocused)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentUser) {
        loadFromCloud();
      }
    });

    // Also reload periodically when focused (every 30 seconds)
    setInterval(() => {
      if (!document.hidden && currentUser) {
        loadFromCloud();
      }
    }, 30000);

    // --- Save ---
    function save() {
      localStorage.setItem('todos', JSON.stringify(todos));
      if (currentUser) pushToCloud();
    }

    // --- Export / Import ---
    function exportTodos() {
      const data = JSON.stringify(todos, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'todo-backup-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importTodos(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error('Invalid format');
          todos = imported;
          save();
          render();
        } catch (err) {
          alert('Invalid file: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // --- CRUD ---
    function addTodo() {
      const text = todoInput.value.trim();
      if (!text) return;
      const description = descInput.value.trim() || null;
      const dueDate = dueDateInput.value || null;
      const priority = priorityInput.value;
      const tags = parseTags(tagInput.value);
      todos.push({ id: Date.now(), text, completed: false, description, dueDate, priority, tags });
      todoInput.value = '';
      descInput.value = '';
      dueDateInput.value = '';
      updateDateLabel();
      priorityInput.value = 'none';
      tagInput.value = '';
      save();
      render();
    }

    function toggleTodo(id) {
      const todo = todos.find(t => t.id === id);
      if (todo) todo.completed = !todo.completed;
      save();
      render();
    }

    function deleteTodo(id) {
      todos = todos.filter(t => t.id !== id);
      save();
      render();
    }

    function startEdit(id) {
      editingId = id;
      render();
      const input = document.getElementById('editText');
      if (input) { input.focus(); input.selectionStart = input.value.length; }
    }

    function cancelEdit() {
      editingId = null;
      render();
    }

    function saveEdit(id) {
      const text = document.getElementById('editText').value.trim();
      if (!text) return;
      const todo = todos.find(t => t.id === id);
      if (todo) {
        todo.text = text;
        todo.description = document.getElementById('editDesc').value.trim() || null;
        todo.dueDate = document.getElementById('editDueDate').value || null;
        todo.priority = document.getElementById('editPriority').value;
        todo.tags = parseTags(document.getElementById('editTags').value);
      }
      editingId = null;
      save();
      render();
    }

    function clearCompleted() {
      todos = todos.filter(t => !t.completed);
      save();
      render();
    }

    // --- Filters & Sort ---
    function setFilter(filter, btn) {
      currentFilter = filter;
      document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render();
    }

    function setSort(sortBy) {
      if (currentSort === sortBy) {
        sortAsc = !sortAsc;
      } else {
        currentSort = sortBy;
        sortAsc = true;
      }
      updateSortButtons();
      render();
    }

    function updateSortButtons() {
      document.querySelectorAll('.sort-bar button').forEach(b => b.classList.remove('active'));
      if (currentSort) {
        const arrow = sortAsc ? ' \u2191' : ' \u2193';
        const btn = document.getElementById('sort' + currentSort.charAt(0).toUpperCase() + currentSort.slice(1));
        btn.classList.add('active');
        const labels = { name: 'Name', date: 'Date', priority: 'Priority' };
        btn.textContent = labels[currentSort] + arrow;
      }
      document.querySelectorAll('.sort-bar button:not(.active)').forEach(b => {
        const labels = { sortName: 'Name', sortDate: 'Date', sortPriority: 'Priority' };
        b.textContent = labels[b.id];
      });
    }

    const priorityOrder = { high: 0, medium: 1, low: 2, none: 3 };

    function sortTodos(list) {
      if (!currentSort) return list;
      const sorted = [...list];
      sorted.sort((a, b) => {
        let cmp = 0;
        if (currentSort === 'name') {
          cmp = a.text.localeCompare(b.text, undefined, { sensitivity: 'base' });
        } else if (currentSort === 'date') {
          const da = a.dueDate || '';
          const db = b.dueDate || '';
          if (!da && !db) cmp = 0;
          else if (!da) cmp = 1;
          else if (!db) cmp = -1;
          else cmp = da.localeCompare(db);
        } else if (currentSort === 'priority') {
          const pa = priorityOrder[a.priority || 'none'];
          const pb = priorityOrder[b.priority || 'none'];
          cmp = pa - pb;
        }
        return sortAsc ? cmp : -cmp;
      });
      return sorted;
    }

    // --- Render ---
    function render() {
      const filtered = todos.filter(t => {
        return currentFilter === 'completed' ? t.completed : !t.completed;
      });

      if (filtered.length === 0 && todos.length === 0) {
        todoList.innerHTML = '<li class="empty-state">No tasks yet. Add one above!</li>';
        statusBar.style.display = 'none';
        return;
      }

      if (filtered.length === 0) {
        const msg = currentFilter === 'completed' ? 'No completed tasks yet.' : 'All tasks completed!';
        todoList.innerHTML = `<li class="empty-state">${msg}</li>`;
      } else {
        const sorted = sortTodos(filtered);
        const today = new Date().toISOString().split('T')[0];
        todoList.innerHTML = sorted.map(t => {
          if (t.id === editingId) {
            const pVal = t.priority || 'none';
            return `
            <li class="todo-item ${t.priority && t.priority !== 'none' ? 'priority-' + t.priority : ''}">
              <div class="edit-form">
                <input type="text" id="editText" value="${escapeAttr(t.text)}" onkeydown="if(event.key==='Escape')cancelEdit();">
                <textarea id="editDesc" placeholder="Description (optional)" rows="2">${escapeHtml(t.description || '')}</textarea>
                <input type="text" class="tag-input" id="editTags" placeholder="Tags (comma separated)" value="${escapeAttr((t.tags || []).join(', '))}">
                <div class="edit-options">
                  <input type="date" id="editDueDate" value="${t.dueDate || ''}">
                  <select id="editPriority">
                    <option value="none" ${pVal === 'none' ? 'selected' : ''}>No priority</option>
                    <option value="low" ${pVal === 'low' ? 'selected' : ''}>Low</option>
                    <option value="medium" ${pVal === 'medium' ? 'selected' : ''}>Medium</option>
                    <option value="high" ${pVal === 'high' ? 'selected' : ''}>High</option>
                  </select>
                  <div class="edit-actions">
                    <button class="save-btn" onclick="saveEdit(${t.id})">Save</button>
                    <button class="cancel-btn" onclick="cancelEdit()">Cancel</button>
                  </div>
                </div>
              </div>
            </li>`;
          }
          const dueDateHtml = t.dueDate
            ? `<span class="due-date ${!t.completed && t.dueDate < today ? 'overdue' : ''}">Due: ${formatDate(t.dueDate)}</span>`
            : '';
          const priorityHtml = t.priority && t.priority !== 'none'
            ? `<span class="priority-badge ${t.priority}">${t.priority}</span>`
            : '';
          const hasMeta = dueDateHtml || priorityHtml;
          const priorityClass = t.priority && t.priority !== 'none' ? `priority-${t.priority}` : '';
          return `
          <li class="todo-item ${t.completed ? 'completed' : ''} ${priorityClass}">
            <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo(${t.id})">
            <div class="todo-content">
              <span class="text">${escapeHtml(t.text)}</span>
              ${t.description ? `<div class="description">${escapeHtml(t.description)}</div>` : ''}
              ${hasMeta ? `<div class="meta">${priorityHtml}${dueDateHtml}</div>` : ''}
              ${t.tags && t.tags.length ? `<div class="tags">${t.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>` : ''}
            </div>
            <div class="actions">
              <button class="edit-btn" onclick="startEdit(${t.id})" title="Edit">&#9998;</button>
              <button class="delete-btn" onclick="deleteTodo(${t.id})" title="Delete">&times;</button>
            </div>
          </li>`;
        }).join('');
      }

      const activeCount = todos.filter(t => !t.completed).length;
      const completedCount = todos.filter(t => t.completed).length;
      itemCount.textContent = `${activeCount} item${activeCount !== 1 ? 's' : ''} left`;
      clearBtn.style.display = completedCount > 0 ? 'inline' : 'none';
      statusBar.style.display = 'flex';
    }

    // --- Helpers ---
    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${m}/${d}/${y}`;
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;');
    }

    function updateDateLabel() {
      const wrapper = document.getElementById('dateWrapper');
      if (dueDateInput.value) {
        wrapper.classList.add('has-value');
      } else {
        wrapper.classList.remove('has-value');
      }
    }

    function parseTags(str) {
      return str.split(',').map(s => s.trim()).filter(s => s.length > 0);
    }

    // --- Dark Mode ---
    function toggleDarkMode() {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark ? 'on' : 'off');
      document.getElementById('darkToggle').innerHTML = isDark ? '&#9788;' : '&#9790;';
    }

    // Apply saved preference on load
    if (localStorage.getItem('darkMode') === 'on') {
      document.body.classList.add('dark');
      document.getElementById('darkToggle').innerHTML = '&#9788;';
    }

    render();
  </script>
</body>
</html>
